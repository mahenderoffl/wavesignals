<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Dynamic SEO -->
  <title id="seo-title">WaveSignals</title>
  <meta
    name="description"
    id="seo-description"
    content="WaveSignals publishes insights, signals, and ideas worth noticing."
  />

  <!-- Canonical (filled dynamically) -->
  <link rel="canonical" id="canonical-url" href="" />

  <meta name="robots" content="index,follow" />
  <meta name="author" content="WaveSignals" />
  <meta name="google-site-verification" content="YOUR_CODE_HERE" />

  <!-- Open Graph -->
  <meta property="og:type" content="article" />
  <meta property="og:site_name" content="WaveSignals" />
  <meta property="og:title" content="WaveSignals" />
  <meta property="og:description" content="WaveSignals article" />
  <meta property="og:url" content="" />
  <meta property="og:image" content="/public/og-default.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="" />
  <meta name="twitter:description" content="" />
  <meta name="twitter:image" content="/public/og-default.png" />

  <!-- Favicon -->
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" href="/favicon.svg" />

  <!-- CSS -->
  <link rel="stylesheet" href="/styles/main.css" />
</head>

<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="container header-inner">

      <div class="brand-container">
        <a href="/app/index.html" class="brand">
          <img
            src="/public/logo-header.svg?v=1"
            alt="WaveSignals logo"
            class="site-logo"
          />
        </a>
      </div>

      <nav class="site-nav">
        <ul class="nav-list">
          <li><a href="/app/index.html" class="nav-link">Home</a></li>
          <li><a href="/about.html" class="nav-link">About</a></li>
          <li><a href="/contact.html" class="nav-link">Contact</a></li>
        </ul>
      </nav>

      <!-- AD_SLOT: header -->
    </div>
  </header>

  <!-- MAIN -->
  <main class="site-main">
    <div class="container">

      <article id="post">
        <h1 id="post-title">Loading…</h1>
        <p class="post-meta">
          <time id="post-date"></time>
        </p>
        <div id="post-content"></div>

        <div id="post-resources" class="post-resources hidden">
          <h3>Related resources</h3>
          <ul id="resource-list"></ul>
        </div>
        
        <!-- AD_SLOT: post-bottom -->

          <!-- Email signup (Buttondown) - quiet, human opt-in -->
          <section class="email-signup">
            <p><strong>Get new signals in your inbox.</strong></p>
            <p style="color:#555;">One clear insight. No spam. Unsubscribe anytime.</p>

            <form id="email-form">
              <input
                type="email"
                id="email-input"
                name="email"
                placeholder="you@example.com"
                required
              />
              <button type="submit">Subscribe</button>
            </form>
            <p id="email-message" style="display:none;color:#0a0;margin-top:8px"></p>
          </section>
      </article>

      <p style="margin-top:2rem;">
        ← <a href="/app/index.html">Back to all posts</a>
      </p>

    </div>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="container">
      <!-- AD_SLOT: footer -->
      <p class="affiliate-disclaimer">We may earn a small commission from links to products or services we recommend. No tracking pixels; no intrusive ads.</p>
      <p>© 2025 WaveSignals. All rights reserved.</p>
    </div>
  </footer>

  <!-- POST LOADER -->
  <script>
    const DATA_URL = "/data/posts.json";

    const params = new URLSearchParams(window.location.search);
    const slug = params.get("slug");

    // ✅ Redirect if no slug
    if (!slug) {
      window.location.replace("/app/index.html");
    }

    async function loadPost() {
      try {
        const res = await fetch(DATA_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to load posts");

        const data = await res.json();
        const posts = Array.isArray(data.posts) ? data.posts : [];

        const post = posts.find(p => p.slug === slug && p.published);

        if (!post) {
          document.getElementById("post-title").textContent = "Post not found";
          return;
        }

        // ===== Populate content =====
        document.title = `${post.title} — WaveSignals`;
        document.getElementById("seo-description").content =
          post.excerpt || post.title;

        // Canonical URL
        const canonical = document.getElementById("canonical-url");
        if (canonical) canonical.href = window.location.href;

        // Open Graph
        const ogTitle = document.querySelector('meta[property="og:title"]');
        if (ogTitle) ogTitle.setAttribute("content", post.title);

        const ogDesc = document.querySelector('meta[property="og:description"]');
        if (ogDesc) ogDesc.setAttribute("content", post.excerpt || post.title);

        const ogUrl = document.querySelector('meta[property="og:url"]');
        if (ogUrl) ogUrl.setAttribute("content", window.location.href);

        // Twitter
        const twTitle = document.querySelector('meta[name="twitter:title"]');
        if (twTitle) twTitle.setAttribute("content", post.title);

        const twDesc = document.querySelector('meta[name="twitter:description"]');
        if (twDesc) twDesc.setAttribute("content", post.excerpt || post.title);

        document.getElementById("post-title").textContent = post.title;
        document.getElementById("post-date").textContent =
          new Date(post.date).toDateString();
        document.getElementById("post-content").innerHTML = post.content;

        // Render resources (soft monetization)
        if (Array.isArray(post.resources) && post.resources.length > 0) {
          const box = document.getElementById("post-resources");
          const list = document.getElementById("resource-list");

          post.resources.forEach(r => {
            const li = document.createElement("li");
            li.innerHTML = `<a href="${r.url}" target="_blank" rel="noopener noreferrer">${r.label}</a>`;
            list.appendChild(li);
          });

          box.classList.remove("hidden");
        }

        // Render optional recommended affiliate section (quiet, contextual)
        if (post.recommendation && post.recommendation.link) {
          const recHtml = `
            <section class="recommended">
              <h4>Related</h4>
              <p>
                If this topic resonates, you might find this useful:
                <a href="${post.recommendation.link}" target="_blank" rel="sponsored noopener noreferrer nofollow">
                  ${post.recommendation.label}
                </a>
              </p>
            </section>
          `;

          const article = document.getElementById("post");
          article.insertAdjacentHTML("beforeend", recHtml);
        }

        // ===== Internal linking: Related Signals (1-2 older published posts)
        try {
          const relatedBox = document.createElement('div');
          relatedBox.id = 'related-signals';
          relatedBox.className = 'related-signals';

          const relatedList = document.createElement('ul');
          relatedList.id = 'related-list';

          const published = posts.filter(p => p.published && p.slug !== slug && new Date(p.date) < new Date(post.date));
          // sort by date desc (most recent older first)
          published.sort((a, b) => new Date(b.date) - new Date(a.date));

          const picks = published.slice(0, 2);
          if (picks.length) {
            const h = document.createElement('h3');
            h.textContent = 'Related Signals';
            relatedBox.appendChild(h);

            picks.forEach(r => {
              const li = document.createElement('li');
              li.innerHTML = `<a href="/app/post.html?slug=${r.slug}">${r.title}</a>`;
              relatedList.appendChild(li);
            });

            relatedBox.appendChild(relatedList);
            const article = document.getElementById('post');
            article.insertAdjacentElement('beforeend', relatedBox);
          }
        } catch (e) {
          // silent
        }

      } catch (err) {
        console.error(err);
        document.getElementById("post-title").textContent = "Error loading post";
      }
    }

    // load post then inject ads
    async function injectAds() {
      try {
        const res = await fetch('/data/ads.json', { cache: 'no-store' });
        if (!res.ok) return;
        const data = await res.json();
        const slots = (data && data.slots) || {};

        const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_COMMENT, null, false);
        const toReplace = [];
        let node;
        while (node = walker.nextNode()) {
          const m = /AD_SLOT:\s*([a-zA-Z0-9_-]+)/.exec(node.nodeValue);
          if (m) toReplace.push({ node, name: m[1] });
        }

        toReplace.forEach(({ node, name }) => {
          const html = slots[name];
          if (html && html.trim()) {
            const wrapper = document.createElement('div');
            wrapper.className = `ad-slot ad-slot-${name.replace(/[^a-z0-9_-]/gi,'')}`;
            try { wrapper.innerHTML = html; } catch (e) { wrapper.textContent = html; }
            node.parentNode.replaceChild(wrapper, node);
          } else {
            node.parentNode.removeChild(node);
          }
        });
      } catch (e) {
        // silent
      }
    }

    (async () => { await loadPost(); await injectAds(); })();
  </script>

  <!-- Analytics+: local-first views, engagement and affiliate capture -->
  <script>
    (function () {
      const slug = new URLSearchParams(location.search).get("slug");
      if (!slug) return;

      // VIEW counter (per-slug)
      try {
        const vKey = "ws_view_" + slug;
        localStorage.setItem(vKey, (Number(localStorage.getItem(vKey)) || 0) + 1);
      } catch (e) {}

      // ENGAGEMENT (60% scroll)
      let fired = false;
      window.addEventListener("scroll", () => {
        const pct = (window.scrollY + innerHeight) / document.body.scrollHeight;
        if (!fired && pct > 0.6) {
          fired = true;
          try { localStorage.setItem("ws_engage_" + slug, Date.now()); } catch (e) {}
        }
      });

      // AFFILIATE CLICK CAPTURE (generic)
      document.addEventListener('click', function (e) {
        const a = e.target.closest && e.target.closest('[data-affiliate]');
        if (!a) return;
        const key = 'ws_aff_' + a.getAttribute('data-affiliate');
        try { localStorage.setItem(key, Date.now()); } catch (err) {}
      });
    })();
  </script>

    <script>
      // Subscribe form handler - posts to local /api/subscribe proxy; falls back to Buttondown embed
      (function(){
        const form = document.getElementById('email-form');
        const input = document.getElementById('email-input');
        const msg = document.getElementById('email-message');
        if (!form) return;

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = input.value.trim();
          if (!email) return;
          // Optimistically store local flag
          try { localStorage.setItem('ws_email_signup', Date.now()); } catch (err) {}

          // Try local proxy
          try {
            const r = await fetch('/api/subscribe', {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email })
            });
            if (r.ok) {
              msg.style.display='block'; msg.style.color='#080'; msg.textContent='Thanks — check your inbox.'; input.value=''; return;
            }
            // If proxy fails, fall through to Buttondown POST
          } catch (err) {
            // ignore and fallback
          }

          // Fallback: submit to Buttondown embed endpoint with form POST (opens same page)
          try {
            const b = document.createElement('form');
            b.method = 'post';
            b.action = 'https://buttondown.email/api/emails/embed-subscribe/wavesignals';
            const i = document.createElement('input'); i.type='hidden'; i.name='email'; i.value = email; b.appendChild(i);
            document.body.appendChild(b); b.submit();
          } catch (e) {
            msg.style.display='block'; msg.style.color='#a00'; msg.textContent = 'Subscription failed.';
          }
        });
      })();
    </script>

</body>
</html>
