<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>WaveSignals Admin</title>

  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="/styles/main.css"> <!-- Re-using main site theme -->

  <style>
    :root {
      --sidebar-width: 260px;
    }

    body {
      background-color: #0f172a;
      /* Slate 900 */
      color: #f1f5f9;
      margin: 0;
      overflow: hidden;
      /* App-like feel */
      display: flex;
    }

    /* --- LOGIN OVERLAY --- */
    #login-screen {
      position: fixed;
      inset: 0;
      background: #0f172a;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
    }

    #login-screen input {
      width: 300px;
      text-align: center;
    }

    /* --- LAYOUT --- */
    .app-shell {
      display: flex;
      width: 100vw;
      height: 100vh;
    }

    /* SIDEBAR */
    .sidebar {
      width: var(--sidebar-width);
      background: rgba(15, 23, 42, 0.95);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 1.5rem;
    }

    .brand-area {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 2.5rem;
      opacity: 0.9;
    }

    .brand-area img {
      height: 28px;
    }

    .brand-area span {
      font-weight: 700;
      font-family: 'Outfit', sans-serif;
      letter-spacing: -0.5px;
    }

    .nav-menu {
      list-style: none;
      padding: 0;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .nav-item {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-muted);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: all 0.2s;
    }

    .nav-item:hover,
    .nav-item.active {
      background: var(--bg-card);
      color: #fff;
    }

    .nav-item.active {
      border-left: 3px solid var(--accent);
    }

    .nav-footer {
      margin-top: auto;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .nav-footer button {
      background: transparent;
      border: 1px solid var(--border);
      width: 100%;
      color: var(--text-muted);
      padding: 0.5rem;
    }

    /* MAIN CONTENT */
    .main-viewport {
      flex: 1;
      overflow-y: auto;
      padding: 2.5rem;
      position: relative;
    }

    .view-section {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .view-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }

      to {
        opacity: 1;
      }
    }

    header h2 {
      margin: 0 0 0.5rem 0;
      font-family: 'Outfit', sans-serif;
      font-size: 1.8rem;
    }

    header p {
      color: var(--text-muted);
      margin: 0 0 2rem 0;
    }

    /* --- DASHBOARD WIDGETS --- */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 1.5rem;
      border-radius: 12px;
    }

    .stat-val {
      font-size: 2rem;
      font-weight: 700;
      color: #fff;
      margin: 0.5rem 0;
    }

    .stat-label {
      color: var(--text-muted);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* --- EDITOR & FORMS --- */
    .form-grid {
      display: grid;
      gap: 1.5rem;
      max-width: 800px;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #1e293b;
      color: #fff;
      font-family: inherit;
      font-size: 1rem;
    }

    textarea {
      min-height: 200px;
      font-family: 'Courier New', monospace;
      line-height: 1.5;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
    }

    /* --- POST LIST --- */
    .post-table-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .post-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s;
    }

    .post-row:last-child {
      border-bottom: none;
    }

    .post-row:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge.published {
      background: rgba(74, 222, 128, 0.2);
      color: #4ade80;
    }

    .badge.draft {
      background: rgba(148, 163, 184, 0.2);
      color: #94a3b8;
    }

    /* MOBILE RESPONSIVENESS */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -280px;
        top: 0;
        bottom: 0;
        z-index: 100;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 4px 0 24px rgba(0, 0, 0, 0.5);
      }

      .sidebar.open {
        transform: translateX(280px);
      }

      .main-viewport {
        padding: 5rem 1.5rem 1.5rem;
        /* More top padding for hamburger */
      }

      .mobile-toggle {
        display: flex !important;
      }

      .mobile-close {
        display: block !important;
      }
    }

    /* HAMBURGER BUTTON (Mobile Only) */
    .mobile-toggle {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 90;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: #fff;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="login-screen">
    <div style="text-align: center;">
      <img src="/public/logo-header.svg?v=1" style="height:40px; margin-bottom:1rem;">
      <h2 style="margin:0;">Access Control</h2>
    </div>
    <input type="password" id="admin-key" placeholder="Enter Admin Key" />
    <button class="btn-primary" id="login-btn" style="width:300px">Authenticate</button>
    <p id="login-error" style="color:#ef4444" class="hidden">Access Denied</p>
  </div>

  <!-- APP SHELL -->
  <div id="app-shell" class="app-shell hidden">

    <!-- MOBILE TOGGLE -->
    <button class="mobile-toggle" onclick="toggleSidebar()">‚ò∞</button>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="brand-area">
        <img src="/public/logo-header.svg?v=1" alt="Logo">
        <span>Admin</span>
        <!-- Close button mobile -->
        <span onclick="toggleSidebar()" style="margin-left:auto; cursor:pointer; font-size:1.5rem; display:none;"
          class="mobile-close">√ó</span>
      </div>

      <ul class="nav-menu">
        <li class="nav-item active" onclick="switchView('dashboard', this); toggleSidebar()">
          <span>üìä</span> Dashboard
        </li>
        <li class="nav-item" onclick="switchView('posts', this); toggleSidebar()">
          <span>üìù</span> Content
        </li>
        <li class="nav-item" onclick="switchView('subscribers', this); toggleSidebar()">
          <span>üë•</span> Audience
        </li>
        <li class="nav-item" onclick="switchView('automation', this); toggleSidebar()">
          <span>ü§ñ</span> Automation
        </li>
        <li class="nav-item" onclick="switchView('settings', this); toggleSidebar()">
          <span>‚öôÔ∏è</span> Settings
        </li>
      </ul>

      <div class="nav-footer">
        <button onclick="location.reload()">Logout</button>
      </div>
    </aside>

    <!-- CONTENT -->
    <main class="main-viewport">

      <!-- VIEW: DASHBOARD -->
      <section id="view-dashboard" class="view-section active">
        <header>
          <h2>Mission Control</h2>
          <p>Real-time performance overview.</p>
        </header>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Revenue</div>
            <div class="stat-val">$0.00</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Signals</div>
            <div class="stat-val" id="d-total-posts">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Subscribers</div>
            <div class="stat-val" id="d-subscribers">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">30-Day Views</div>
            <div class="stat-val" id="d-views">-</div>
          </div>
        </div>

        <h3>Recent Activity</h3>
        <div class="post-table-container" id="dashboard-activity">
          <div class="post-row" style="color:var(--text-muted); justify-content:center;">Loading...</div>
        </div>
      </section>

      <!-- VIEW: POSTS -->
      <section id="view-posts" class="view-section">
        <header style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <h2>Content Library</h2>
            <p>Manage your signals and essays.</p>
          </div>
          <button class="btn-primary" onclick="createNewPost()">+ New Signal</button>
        </header>

        <!-- Editor (Hidden by default) -->
        <div id="editor-ui" class="hidden"
          style="margin-bottom: 2rem; background: var(--bg-card); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border);">
          <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
            <h3 style="margin:0;">Editor</h3>
            <button class="btn-secondary" onclick="closeEditor()"
              style="padding:4px 12px; font-size:0.8rem;">Close</button>
          </div>

          <div class="form-grid">
            <input id="edit-title" placeholder="Title" />
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
              <input id="edit-slug" placeholder="Slug (optional)" />
              <input id="edit-date" type="datetime-local" />
            </div>
            <textarea id="edit-excerpt" style="min-height:80px" placeholder="Excerpt (SEO Description)"></textarea>
            <textarea id="edit-content" style="min-height:300px" placeholder="HTML Content..."></textarea>

            <div style="display:flex; gap: 1rem; align-items:center;">
              <label style="display:flex; gap:0.5rem; align-items:center; cursor:pointer;">
                <input type="checkbox" id="edit-publish" style="width:auto;"> Publish immediately
              </label>
              <div style="flex:1;"></div>
              <button class="btn-secondary" id="editor-preview-btn">Preview</button>
              <button class="btn-primary" id="editor-save-btn">Save Content</button>
            </div>
          </div>
        </div>

        <div class="post-table-container" id="posts-list-container">
          <!-- Populated by JS -->
        </div>
      </section>

      <!-- VIEW: AUTOMATION -->
      <section id="view-automation" class="view-section">
        <header>
          <h2>Automation Engine</h2>
          <p>Configure your digital employees.</p>
        </header>

        <div class="card"
          style="background:var(--bg-card); padding:2rem; border-radius:12px; border:1px solid var(--border); max-width:600px;">
          <h3 style="margin-top:0;">Bot Status: <span style="color:#4ade80">Active</span></h3>
          <p style="color:var(--text-muted)">The content generator runs on a schedule (Mon, Wed, Fri).</p>

          <div style="margin-top:2rem; display:flex; flex-direction:column; gap:1rem;">
            <label
              style="display:flex; gap:1rem; align-items:center; padding:1rem; border:1px solid var(--border); border-radius:8px;">
              <input type="checkbox" checked style="width:20px; height:20px;">
              <div>
                <strong>Auto-Publish</strong>
                <div style="font-size:0.85rem; color:var(--text-muted)">Allow bot to publish directly without draft
                  review.</div>
              </div>
            </label>

            <label
              style="display:flex; gap:1rem; align-items:center; padding:1rem; border:1px solid #7f1d1d; background:rgba(127,29,29,0.1); border-radius:8px;">
              <input type="checkbox" style="width:20px; height:20px;">
              <div>
                <strong style="color:#f87171">Emergency Stop</strong>
                <div style="font-size:0.85rem; color:#fca5a5">Halt all automated activities immediately.</div>
              </div>
            </label>
          </div>
        </div>
      </section>

      <!-- VIEW: SUBSCRIBERS (NEW) -->
      <section id="view-subscribers" class="view-section">
        <header>
          <h2>Audience</h2>
          <p>Locally stored email list.</p>
        </header>
        <div class="post-table-container">
          <div id="subscribers-list">Loading...</div>
        </div>
      </section>

      <!-- VIEW: SETTINGS -->
      <section id="view-settings" class="view-section">
        <header>
          <h2>Settings</h2>
          <p>Global configuration and Ad slots.</p>
        </header>

        <div class="form-grid">
          <!-- ADS -->
          <div style="background:var(--bg-card); padding:1.5rem; border-radius:12px; border:1px solid var(--border);">
            <h3>Ad Slots (Revenue)</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <label>Header (All Pages)</label>
                <textarea id="set-ad-header" style="min-height:80px; margin-bottom:1rem;"
                  placeholder="Top banner..."></textarea>
              </div>
              <div>
                <label>Footer (All Pages)</label>
                <textarea id="set-ad-footer" style="min-height:80px; margin-bottom:1rem;"
                  placeholder="Bottom banner..."></textarea>
              </div>
            </div>

            <label>Post Bottom (Article End)</label>
            <textarea id="set-ad-bottom" style="min-height:80px; margin-bottom:1rem;"
              placeholder="After content..."></textarea>

            <div
              style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top:1rem; padding-top:1rem; border-top:1px solid var(--border);">
              <div>
                <label>Left Sidebar (Desktop Only)</label>
                <textarea id="set-ad-left" style="min-height:120px;" placeholder="Skyscraper (160x600)..."></textarea>
              </div>
              <div>
                <label>Right Sidebar (Desktop Only)</label>
                <textarea id="set-ad-right" style="min-height:120px;" placeholder="Skyscraper (160x600)..."></textarea>
              </div>
            </div>

            <button class="btn-primary" id="save-ads-btn" style="margin-top:1.5rem;">Save Ad Slots</button>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script>
    /* LOGIC */
    const ADMIN_KEY = 'wavesignals@2025';
    let posts = [];
    let subscribers = [];

    // Auth
    document.getElementById('login-btn').onclick = () => {
      if (document.getElementById('admin-key').value === ADMIN_KEY) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-shell').classList.remove('hidden');
        init();
      } else {
        document.getElementById('login-error').classList.remove('hidden');
      }
    };

    // Routing
    window.switchView = (viewName, el) => {
      document.querySelectorAll('.view-section').forEach(d => d.classList.remove('active'));
      document.getElementById('view-' + viewName).classList.add('active');

      document.querySelectorAll('.nav-item').forEach(d => d.classList.remove('active'));
      if (el) el.classList.add('active');
    };

    async function init() {
      await loadData();
      await loadAds();
      await loadSubscribers();
      renderDashboard();
      renderPosts();
      renderSubscribers();
    }

    async function loadData() {
      try {
        const r = await fetch('/data/posts.json');
        const d = await r.json();
        posts = d.posts || [];
      } catch (e) { posts = []; }
    }

    async function loadSubscribers() {
      try {
        const r = await fetch('/api/subscribers');
        subscribers = await r.json();
      } catch (e) { subscribers = []; }
    }

    async function loadAds() {
      try {
        const r = await fetch('/api/ads');
        const d = await r.json();
        ads = d || { slots: {} };
        if (!ads.slots) ads.slots = {};
      } catch (e) { ads = { slots: {} }; }

      document.getElementById('set-ad-header').value = ads.slots.header || '';
      document.getElementById('set-ad-footer').value = ads.slots.footer || '';
      document.getElementById('set-ad-bottom').value = ads.slots['post-bottom'] || '';
      document.getElementById('set-ad-left').value = ads.slots['sidebar-left'] || '';
      document.getElementById('set-ad-right').value = ads.slots['sidebar-right'] || '';
    }

    document.getElementById('save-ads-btn').onclick = async () => {
      ads.slots.header = document.getElementById('set-ad-header').value;
      ads.slots.footer = document.getElementById('set-ad-footer').value;
      ads.slots['post-bottom'] = document.getElementById('set-ad-bottom').value;
      ads.slots['sidebar-left'] = document.getElementById('set-ad-left').value;
      ads.slots['sidebar-right'] = document.getElementById('set-ad-right').value;

      try {
        const r = await fetch('/api/ads', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(ads)
        });
        if (r.ok) alert('Ad config saved!');
        else throw new Error('Server error');
      } catch (e) { alert('Error: ' + e); }
    };

    /* DASHBOARD */
    function renderDashboard() {
      document.getElementById('d-total-posts').innerText = posts.length;
      document.getElementById('d-subscribers').innerText = subscribers.length;

      // Calculate views from local storage for demo
      let views = 0;
      for (let k in localStorage) { if (k.startsWith('ws_view_')) views += Number(localStorage.getItem(k)); }
      document.getElementById('d-views').innerText = views;

      // Recent Activity
      const list = document.getElementById('dashboard-activity');
      list.innerHTML = '';
      posts.slice(0, 5).forEach(p => {
        list.innerHTML += `
      <div class="post-row">
        <div>${p.title}</div>
        <div style="font-size:0.8rem; color:var(--text-muted)">${new Date(p.date).toLocaleDateString()}</div>
      </div>
    `;
      });
    }

    /* SUBSCRIBERS */
    function renderSubscribers() {
      const c = document.getElementById('subscribers-list');
      c.innerHTML = '';
      if (!subscribers.length) {
        c.innerHTML = '<div style="padding:1rem;">No subscribers yet.</div>';
        return;
      }
      subscribers.reverse().forEach(s => {
        const div = document.createElement('div');
        div.className = 'post-row';
        div.innerHTML = `<div>${s.email}</div><div style="font-size:0.8rem; color:var(--text-muted)">${new Date(s.date).toLocaleDateString()}</div>`;
        c.appendChild(div);
      });
    }

    /* POSTS */
    function renderPosts() {
      const c = document.getElementById('posts-list-container');
      c.innerHTML = '';

      posts.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(p => {
        const div = document.createElement('div');
        div.className = 'post-row';
        div.innerHTML = `
          <div>
            <div style="font-weight:600; font-size:1.05rem;">${p.title}</div>
            <div style="font-size:0.85rem; color:var(--text-muted)">/${p.slug}</div>
          </div>
          <div style="display:flex; gap:0.5rem; align-items:center;">
            <span class="badge ${p.published ? 'published' : 'draft'}">${p.published ? 'Published' : 'Draft'}</span>
            <button class="btn-secondary" style="padding:6px 12px; font-size:0.85rem;" onclick="editPost('${p.id}')">Edit</button>
            <button class="btn-secondary" style="padding:6px 12px; font-size:0.85rem; color:#f87171; border-color:#f87171;" onclick="deletePost('${p.id}')">Delete</button>
          </div>
        `;
        c.appendChild(div);
      });
    }

    window.deletePost = async (id) => {
      if (!confirm('Delete this signal permanently?')) return;
      try {
        const r = await fetch('/api/posts/' + id, { method: 'DELETE' });
        if (r.ok) {
          posts = posts.filter(p => String(p.id) !== String(id));
          renderPosts();
          renderDashboard();
        } else {
          alert('Failed to delete on server');
        }
      } catch (e) { alert('Error: ' + e); }
    };

    /* EDITOR LOGIC */
    let currentId = null;

    window.createNewPost = () => {
      currentId = null;
      openEditor();
    };

    window.editPost = (id) => {
      const p = posts.find(x => x.id == id); // loose equal for string/int ids
      if (!p) return;
      currentId = id;
      document.getElementById('edit-title').value = p.title;
      document.getElementById('edit-slug').value = p.slug;
      document.getElementById('edit-excerpt').value = p.excerpt;
      document.getElementById('edit-content').value = p.content;
      document.getElementById('edit-publish').checked = p.published;
      openEditor();
    };

    function openEditor() {
      document.getElementById('editor-ui').classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    window.closeEditor = () => {
      document.getElementById('editor-ui').classList.add('hidden');
      document.getElementById('edit-title').value = '';
      document.getElementById('edit-content').value = '';
    };

    document.getElementById('editor-save-btn').onclick = async () => {
      const title = document.getElementById('edit-title').value;
      const content = document.getElementById('edit-content').value;
      if (!title) return alert('Title required');

      const p = {
        id: currentId || Date.now(),
        title,
        slug: document.getElementById('edit-slug').value || title.toLowerCase().replace(/ /g, '-'),
        excerpt: document.getElementById('edit-excerpt').value,
        content,
        published: document.getElementById('edit-publish').checked,
        date: new Date().toISOString()
      };

      if (currentId) {
        const idx = posts.findIndex(x => x.id == currentId);
        if (idx >= 0) posts[idx] = p;
      } else {
        posts.unshift(p);
      }

      // Save to server
      try {
        await fetch('/api/posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(p)
        });
        alert('Saved!');
        closeEditor();
        renderPosts();
        renderDashboard();
      } catch (e) { alert('Error saving' + e); }
    };

  </script>
</body>

</html>